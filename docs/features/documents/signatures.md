# ‚úçÔ∏è Assinaturas Digitais - AlphaClinic QMS

## Vis√£o Geral

O sistema de assinaturas digitais do AlphaClinic QMS oferece conformidade legal completa com a legisla√ß√£o brasileira (ICP-Brasil) e normas internacionais, garantindo validade jur√≠dica para documentos eletr√¥nicos em ambientes cl√≠nicos.

## üîê Conformidade Legal

### Legisla√ß√£o Brasileira
- **Lei 14.063/2020**: Assinatura eletr√¥nica avan√ßada
- **MP 2.200-2/2001**: Infraestrutura de Chaves P√∫blicas Brasileira (ICP-Brasil)
- **C√≥digo Civil**: Artigos 104 e 107 sobre validade de documentos digitais

### Normas T√©cnicas
- **DOC-ICP-15**: Padr√µes t√©cnicos do ICP-Brasil
- **ISO 27001**: Gest√£o de seguran√ßa da informa√ß√£o
- **ISO 9001**: Gest√£o da qualidade

## üìã Tipos de Assinatura

### 1. Assinatura Eletr√¥nica Simples
- **Uso**: Documentos internos de baixo risco
- **Caracter√≠sticas**:
  - Login e senha
  - IP e timestamp
  - N√£o criptografada
- **Validade jur√≠dica**: Limitada

### 2. Assinatura Eletr√¥nica Avan√ßada
- **Uso**: Documentos de m√©dia import√¢ncia
- **Caracter√≠sticas**:
  - Certificado digital pessoal
  - Biometria opcional
  - Criptografia assim√©trica
- **Validade jur√≠dica**: M√©dia

### 3. Assinatura Eletr√¥nica Qualificada
- **Uso**: Documentos cr√≠ticos (prontu√°rios, contratos)
- **Caracter√≠sticas**:
  - Certificado ICP-Brasil A1, A3 ou A4
  - Biometria obrigat√≥ria
  - Carimbo de tempo qualificado
  - Auditoria completa
- **Validade jur√≠dica**: Plena

## üîß Configura√ß√£o T√©cnica

### Certificados Digitais

#### Tipos de Certificado Suportados
```javascript
const supportedCertificates = {
  "A1": {
    "description": "Arquivo digital (software)",
    "validity": "1 ano",
    "storage": "Computador/Token",
    "use": "Assinatura remota"
  },
  "A3": {
    "description": "Cart√£o ou Token USB",
    "validity": "1-3 anos",
    "storage": "Hardware criptogr√°fico",
    "use": "Assinatura com prote√ß√£o f√≠sica"
  },
  "A4": {
    "description": "Servidor HSM",
    "validity": "1-5 anos",
    "storage": "Hardware Security Module",
    "use": "Alto volume de assinaturas"
  }
};
```

#### Autoridades Certificadoras Credenciadas
- ‚úÖ Serasa Experian
- ‚úÖ Certisign
- ‚úÖ Valid Certificadora
- ‚úÖ Digitalsign
- ‚úÖ Caixa Econ√¥mica Federal

### Integra√ß√£o com Dispositivos Biom√©tricos

#### Leitores Suportados
- **Huion Kamvas** (mesa digitalizadora)
- **Wacom** (tablets profissionais)
- **Topaz** (assinatura digital)
- **C√¢meras** (reconhecimento facial)

#### Configura√ß√£o de Biometria
```bash
# Configura√ß√µes de captura biom√©trica
BIOMETRIC_MIN_QUALITY=0.8      # Qualidade m√≠nima (0-1)
BIOMETRIC_TIMEOUT=30           # Timeout em segundos
BIOMETRIC_RETRIES=3            # Tentativas permitidas

# Dispositivos suportados
SUPPORTED_DEVICES=huion,wacom,topaz,camera
```

## üìù Processo de Assinatura

### 1. Prepara√ß√£o do Documento

#### Sele√ß√£o de Signat√°rios
```javascript
const signatories = [
  {
    "user_id": 1,
    "role": "creator",
    "signature_type": "elaborador",
    "required": true,
    "order": 1
  },
  {
    "user_id": 2,
    "role": "reviewer",
    "signature_type": "revisor",
    "required": true,
    "order": 2
  },
  {
    "user_id": 3,
    "role": "approver",
    "signature_type": "aprovador",
    "required": true,
    "order": 3
  }
];
```

#### Configura√ß√£o de Regras
- **Ordem obrigat√≥ria**: Assinaturas sequenciais
- **Assinatura paralela**: M√∫ltiplas assinaturas simult√¢neas
- **Testemunhas**: Assinaturas adicionais para validade
- **Visto**: Aprova√ß√£o sem assinatura formal

### 2. Processo de Assinatura

#### Fluxo de Assinatura
```mermaid
graph TD
    A[Documento Pronto] --> B[Notifica√ß√£o de Signat√°rios]
    B --> C[Primeiro Signat√°rio]
    C --> D{Certificado V√°lido?}
    D -->|N√£o| E[Erro: Certificado Inv√°lido]
    D -->|Sim| F[Captura Biom√©trica]
    F --> G{Autentica√ß√£o OK?}
    G -->|N√£o| H[Repetir Captura]
    G -->|Sim| I[Aplicar Assinatura]
    I --> J[Carimbo de Tempo]
    J --> K[Validar Integridade]
    K --> L{Sucesso?}
    L -->|N√£o| M[Erro: Assinatura Falhou]
    L -->|Sim| N{Pr√≥ximo Signat√°rio?}
    N -->|Sim| C
    N -->|N√£o| O[Documento Finalizado]
```

### 3. Valida√ß√£o e Verifica√ß√£o

#### Valida√ß√£o T√©cnica
- **Integridade do documento**: Hash SHA-256
- **Validade do certificado**: Verifica√ß√£o da cadeia de confian√ßa
- **Carimbo de tempo**: Sincroniza√ß√£o com servidor NTP
- **Biometria**: Compara√ß√£o com padr√µes armazenados

#### Verifica√ß√£o Jur√≠dica
```javascript
// Processo de verifica√ß√£o
const verification = {
  "certificate_chain": "Verificar AC credenciada",
  "timestamp": "Verificar servidor de tempo",
  "biometric": "Comparar com padr√£o armazenado",
  "document_integrity": "Recalcular hash",
  "legal_compliance": "Verificar conformidade ICP-Brasil"
};
```

## üîí Seguran√ßa e Auditoria

### Criptografia e Prote√ß√£o

#### Algoritmos Utilizados
- **Assinatura**: RSA 2048/4096 bits ou ECDSA P-256/P-384
- **Hash**: SHA-256/SHA-384/SHA-512
- **Criptografia**: AES-256-GCM para dados sens√≠veis
- **Troca de chaves**: ECDH com curva P-256

#### Prote√ß√£o de Chaves Privadas
```javascript
const keyProtection = {
  "A1": {
    "storage": "Arquivo protegido por senha",
    "encryption": "AES-256",
    "access_control": "PIN/Token"
  },
  "A3": {
    "storage": "Hardware criptogr√°fico",
    "encryption": "HSM integrado",
    "access_control": "PIN f√≠sico"
  },
  "A4": {
    "storage": "HSM dedicado",
    "encryption": "M√≥dulo de seguran√ßa",
    "access_control": "Controle de acesso duplo"
  }
};
```

### Auditoria Completa

#### Registro de Eventos
- üìÖ **Timestamp**: Data/hora exata da assinatura
- üåê **IP/Location**: Endere√ßo IP e localiza√ß√£o geogr√°fica
- üîê **Certificado**: Dados do certificado utilizado
- üë§ **Biometria**: Dados biom√©tricos (hash)
- üìÑ **Documento**: Hash e metadados
- üîó **Transa√ß√£o**: ID √∫nico da opera√ß√£o

#### Reten√ß√£o de Dados
```bash
# Configura√ß√µes de reten√ß√£o
AUDIT_LOG_RETENTION=2555  # 7 anos conforme legisla√ß√£o
BIOMETRIC_DATA_RETENTION=365  # 1 ano para dados biom√©tricos
CERTIFICATE_DATA_RETENTION=2555  # Manter com documento
```

## üì± Interface do Usu√°rio

### Processo de Assinatura

#### Tela de Assinatura
```html
<!-- Interface de assinatura -->
<div class="signature-interface">
  <div class="document-preview">
    <!-- Visualiza√ß√£o do documento -->
  </div>

  <div class="signature-area">
    <canvas id="signature-pad" width="600" height="200">
      <!-- √Årea de assinatura digital -->
    </canvas>

    <div class="biometric-capture">
      <!-- Captura biom√©trica -->
      <video id="biometric-camera" autoplay></video>
    </div>

    <div class="certificate-info">
      <!-- Informa√ß√µes do certificado -->
      <p>Certificado: Jo√£o Silva - CPF: 123.456.789-00</p>
      <p>Validade: 01/01/2024 - 31/12/2024</p>
      <p>Autoridade: Serasa Experian</p>
    </div>
  </div>

  <div class="actions">
    <button onclick="clearSignature()">Limpar</button>
    <button onclick="captureBiometric()">Capturar Biometria</button>
    <button onclick="signDocument()">Assinar Documento</button>
  </div>
</div>
```

### Valida√ß√£o Visual

#### Elementos de Seguran√ßa Visuais
- üîê **Selo digital**: Indicador visual de autenticidade
- üìÖ **Carimbo de tempo**: Data/hora da assinatura
- üë§ **Identifica√ß√£o do signat√°rio**: Nome e fun√ß√£o
- üîó **C√≥digo de verifica√ß√£o**: QR Code para valida√ß√£o externa

## üîß APIs e Integra√ß√µes

### API de Assinatura

#### Endpoint de Assinatura
```bash
# Assinar documento
POST /api/v1/documents/{id}/sign
Content-Type: application/json
X-API-Key: sua-api-key
X-Digital-Certificate: certificado-base64

{
  "signature_type": "qualified",
  "biometric_data": "dados-biometricos-base64",
  "certificate_pin": "pin-do-certificado",
  "metadata": {
    "ip_address": "192.168.1.100",
    "user_agent": "Mozilla/5.0...",
    "location": "S√£o Paulo, SP"
  }
}
```

#### Resposta da API
```json
{
  "success": true,
  "signature_id": "sig_abc123def456",
  "timestamp": "2024-12-01T10:30:00Z",
  "certificate_info": {
    "serial": "123456789",
    "issuer": "AC Serasa Experian",
    "valid_from": "2024-01-01T00:00:00Z",
    "valid_to": "2024-12-31T23:59:59Z"
  },
  "document_hash": "sha256:a1b2c3d4e5f6...",
  "audit_trail": "audit_abc123def456"
}
```

### Webhooks de Assinatura

#### Eventos Dispon√≠veis
- `document.signed`: Documento assinado
- `document.all_signed`: Todas as assinaturas coletadas
- `signature.verified`: Assinatura verificada
- `signature.expired`: Certificado expirado

#### Payload do Webhook
```json
{
  "event": "document.signed",
  "timestamp": "2024-12-01T10:30:00Z",
  "document": {
    "id": 123,
    "code": "PROC-001",
    "title": "Procedimento de Higieniza√ß√£o",
    "version": "1.0"
  },
  "signature": {
    "id": "sig_abc123def456",
    "type": "qualified",
    "signatory": {
      "id": 1,
      "name": "Jo√£o Silva",
      "role": "Enfermeiro Chefe"
    }
  },
  "verification_url": "https://qms.alphaclin.com/verify/sig_abc123def456"
}
```

## üìä Relat√≥rios e M√©tricas

### Indicadores de Assinatura

#### KPIs Dispon√≠veis
- üìà **Taxa de sucesso de assinaturas**: Meta > 95%
- ‚è±Ô∏è **Tempo m√©dio de assinatura**: Meta < 2 minutos
- üìÖ **Assinaturas por dia/m√™s**: Acompanhamento de volume
- üîê **Taxa de valida√ß√£o biom√©trica**: Meta > 98%

#### Dashboards
- üìä **Status de assinaturas pendentes**
- ‚è∞ **Documentos aguardando assinatura**
- üìà **M√©tricas de performance**
- üîç **Auditoria de assinaturas**

### Relat√≥rios de Conformidade

#### Relat√≥rio de Assinaturas
```bash
# Relat√≥rio mensal de assinaturas
GET /api/v1/reports/signatures/monthly?year=2024&month=12

# Resposta
{
  "total_signatures": 150,
  "by_type": {
    "simple": 45,
    "advanced": 75,
    "qualified": 30
  },
  "by_department": {
    "enfermagem": 60,
    "qualidade": 45,
    "administrativo": 45
  },
  "compliance_rate": 0.98,
  "average_time": "1m 45s"
}
```

## üö® Tratamento de Erros

### Cen√°rios de Falha

#### Certificado Inv√°lido
```javascript
const certificateErrors = {
  "expired": "Certificado digital expirado",
  "revoked": "Certificado revogado pela AC",
  "invalid_chain": "Cadeia de certifica√ß√£o inv√°lida",
  "unsupported_type": "Tipo de certificado n√£o suportado"
};
```

#### Falha Biom√©trica
```javascript
const biometricErrors = {
  "low_quality": "Qualidade da captura insuficiente",
  "no_match": "Biometria n√£o confere com padr√£o",
  "device_error": "Problema no dispositivo biom√©trico",
  "timeout": "Tempo limite excedido"
};
```

#### Problemas de Rede
```javascript
const networkErrors = {
  "timestamp_unavailable": "Servidor de carimbo de tempo indispon√≠vel",
  "certificate_server_down": "Servidor de certificados inacess√≠vel",
  "audit_server_error": "Erro no servidor de auditoria"
};
```

## üéØ Melhores Pr√°ticas

### Para Administradores
- ‚úÖ Mantenha certificados sempre atualizados
- ‚úÖ Configure alertas de vencimento (60 dias)
- ‚úÖ Treine usu√°rios regularmente
- ‚úÖ Monitore m√©tricas de assinatura
- ‚úÖ Fa√ßa backups regulares dos dados de auditoria

### Para Usu√°rios
- ‚úÖ Mantenha certificado digital v√°lido
- ‚úÖ Use dispositivos biom√©tricos de qualidade
- ‚úÖ Verifique dados antes de assinar
- ‚úÖ Mantenha PIN/Token em seguran√ßa
- ‚úÖ Reporte problemas imediatamente

### Para TI/Suporte
- ‚úÖ Monitore servidores de certifica√ß√£o
- ‚úÖ Mantenha integra√ß√µes atualizadas
- ‚úÖ Teste assinaturas regularmente
- ‚úÖ Documente procedimentos de conting√™ncia

## üìû Suporte e Troubleshooting

### Problemas Comuns

#### Certificado N√£o Reconhecido
```bash
# Verificar instala√ß√£o do certificado
certutil -user -store MY

# Testar validade
openssl x509 -in certificado.crt -text -noout

# Reinstalar drivers
# Dispositivos biom√©tricos > Propriedades > Drivers
```

#### Falha na Biometria
```bash
# Verificar dispositivo
lsusb  # Linux
# Gerenciador de Dispositivos > Dispositivos Biom√©tricos  # Windows

# Testar captura
python scripts/test_biometric.py
```

#### Problemas de Performance
```bash
# Monitorar recursos
htop  # Uso de CPU/Mem√≥ria

# Logs de assinatura
tail -f logs/signature.log

# Otimizar configura√ß√µes
# Ajustar timeouts e qualidade biom√©trica
```

## üîÆ Funcionalidades Futuras

### Pr√≥ximas Implementa√ß√µes
- üì± **Assinatura mobile** com Touch ID/Face ID
- ü§ñ **Intelig√™ncia artificial** para valida√ß√£o biom√©trica
- ‚õìÔ∏è **Blockchain** para auditoria imut√°vel
- üåê **Assinatura remota** via certifica√ß√£o em nuvem
- üìã **Lote de assinaturas** para alta volume

---

**√öltima atualiza√ß√£o:** Dezembro 2024
**Vers√£o:** 1.0.0