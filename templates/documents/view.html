{% extends "base.html" %}

{% block title %}{{ document.title }} - Alphaclin QMS{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Document Header -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-file-alt text-2xl text-blue-600"></i>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900 truncate">
                                {{ document.title }}
                            </h1>
                            {% if document.code %}
                            <p class="text-sm text-gray-500">
                                <i class="fas fa-barcode mr-1"></i>{{ document.code }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                        {% if document.status.value == 'draft' %}bg-gray-100 text-gray-800
                        {% elif document.status.value == 'review' %}bg-yellow-100 text-yellow-800
                        {% elif document.status.value == 'published' %}bg-green-100 text-green-800
                        {% elif document.status.value == 'archived' %}bg-red-100 text-red-800
                        {% endif %}">
                        {% if document.status.value == 'draft' %}<i class="fas fa-edit mr-1"></i>Rascunho
                        {% elif document.status.value == 'review' %}<i class="fas fa-clock mr-1"></i>Em Revisão
                        {% elif document.status.value == 'published' %}<i class="fas fa-check-circle mr-1"></i>Publicado
                        {% elif document.status.value == 'archived' %}<i class="fas fa-archive mr-1"></i>Arquivado
                        {% endif %}
                    </span>
                    
                    {% if document.created_by_id == current_user.id or current_user.role.value in ['admin', 'manager'] %}
                    <a href="{{ url_for('documents.edit', id=document.id) }}" 
                       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-edit mr-1"></i> Editar
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Document Info -->
        <div class="px-6 py-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <dt class="text-sm font-medium text-gray-500">Versão</dt>
                    <dd class="mt-1 text-sm text-gray-900 font-mono">{{ document.version }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Criado por</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ document.creator.full_name }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Data de criação</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ document.created_at.strftime('%d/%m/%Y às %H:%M') }}</dd>
                </div>
                {% if document.category %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Categoria</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ document.category }}</dd>
                </div>
                {% endif %}
                {% if document.folder %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Pasta</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ document.folder.name }}</dd>
                </div>
                {% endif %}
                {% if document.norms %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Normas Associadas</dt>
                    <dd class="mt-1">
                        {% for norm in document.norms %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mr-2 mb-1">
                            {{ norm.name }} ({{ norm.code }})
                        </span>
                        {% endfor %}
                    </dd>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Workflow Actions -->
    {% if document.status.value in ['draft', 'review'] and (document.created_by_id == current_user.id or current_user.role.value in ['admin', 'manager', 'reviewer']) %}
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fas fa-route mr-2"></i>Ações do Workflow
        </h3>

        <div class="flex flex-wrap gap-3">
            {% if document.status.value == 'draft' %}
                <form method="POST" action="{{ url_for('documents.workflow_action', id=document.id, action='submit_for_review') }}" class="inline">
                    <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-paper-plane mr-1"></i> Enviar para Revisão
                    </button>
                </form>
            {% elif document.status.value == 'review' and current_user.id == document.reviewed_by_id %}
                <form method="POST" action="{{ url_for('documents.workflow_action', id=document.id, action='approve') }}" class="inline">
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-check mr-1"></i> Aprovar e Publicar
                    </button>
                </form>
                <form method="POST" action="{{ url_for('documents.workflow_action', id=document.id, action='reject') }}" class="inline">
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-times mr-1"></i> Rejeitar
                    </button>
                </form>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Electronic Signatures -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">
                <i class="fas fa-signature mr-2"></i>Assinaturas Eletrônicas
            </h3>
            <a href="{{ url_for('documents.document_signatures', id=document.id) }}"
               class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-list mr-1"></i> Ver Todas
            </a>
        </div>

        <!-- Signature Actions -->
        <div class="flex flex-wrap gap-3 mb-4">
            {% if document.status.value == 'review' and current_user.id == document.reviewed_by_id %}
            <a href="{{ url_for('documents.sign_document', id=document.id, signature_type='review') }}"
               class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-signature mr-1"></i> Assinar Revisão
            </a>
            {% endif %}

            {% if document.status.value == 'review' and current_user.role.value in ['admin', 'manager'] %}
            <a href="{{ url_for('documents.sign_document', id=document.id, signature_type='approval') }}"
               class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-check-circle mr-1"></i> Assinar Aprovação
            </a>
            {% endif %}

            {% if document.status.value == 'published' %}
            <a href="{{ url_for('documents.sign_document', id=document.id, signature_type='reading') }}"
               class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-book-reader mr-1"></i> Confirmar Leitura
            </a>
            {% endif %}
        </div>

        <!-- Recent Signatures -->
        {% if document.signatures %}
        <div class="space-y-3">
            <h4 class="text-sm font-medium text-gray-700 uppercase tracking-wide">Assinaturas Recentes</h4>
            {% for signature in document.signatures[:3] %}
            <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 h-8 w-8">
                        <div class="h-8 w-8 rounded-full bg-gray-300 flex items-center justify-center">
                            <span class="text-xs font-medium text-gray-700">
                                {{ signature.user.full_name.split()[0][0] }}{% if signature.user.full_name.split()|length > 1 %}{{ signature.user.full_name.split()[1][0] }}{% endif %}
                            </span>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-900">{{ signature.user.full_name }}</p>
                        <p class="text-xs text-gray-500">
                            {{ signature.signature_type.value|title }} • {{ signature.signed_at.strftime('%d/%m/%Y %H:%M') }}
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    {% if signature.is_valid %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <i class="fas fa-star mr-1"></i>Válida
                    </span>
                    {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        <i class="fas fa-exclamation-triangle mr-1"></i>Problema
                    </span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

            {% if document.signatures|length > 3 %}
            <div class="text-center">
                <a href="{{ url_for('documents.document_signatures', id=document.id) }}"
                   class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    Ver todas as {{ document.signatures|length }} assinaturas →
                </a>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <i class="fas fa-signature text-gray-400 text-4xl mb-4"></i>
            <p class="text-gray-600">Nenhuma assinatura registrada ainda.</p>
            <p class="text-sm text-gray-500 mt-1">As assinaturas aparecerão aqui após serem realizadas.</p>
        </div>
        {% endif %}
    </div>

    <!-- Document Content -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-file-text mr-2"></i>Conteúdo do Documento
                </h3>
                <div class="flex items-center space-x-2">
                    {% if document.status.value == 'published' %}
                    <button type="button" id="confirm-read-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-check-circle mr-1"></i> Confirmar Leitura
                    </button>
                    <button type="button" onclick="printDocument()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-print mr-1"></i> Imprimir
                    </button>

                    <!-- Dropdown de Download PDF -->
                    <div class="relative" id="pdf-dropdown">
                        <button type="button" onclick="togglePdfDropdown()"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-download mr-1"></i> PDF
                            <i class="fas fa-chevron-down ml-1 text-xs"></i>
                        </button>

                        <div id="pdf-dropdown-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 hidden">
                            <div class="py-1">
                                <a href="{{ url_for('documents.download_pdf', id=document.id, orientation='portrait') }}"
                                   class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-file-pdf mr-2"></i>Download PDF (Retrato)
                                </a>
                                <a href="{{ url_for('documents.download_pdf', id=document.id, orientation='landscape') }}"
                                   class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-file-pdf mr-2"></i>Download PDF (Paisagem)
                                </a>
                                <button onclick="printDocument()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-print mr-2"></i>Visualizar Impressão
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="px-6 py-6">
            <div class="prose max-w-none" id="document-content">
                {{ document.content|safe }}
            </div>
        </div>
    </div>

    <!-- Document History/Versions -->
    {% if document.versions %}
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">
                <i class="fas fa-history mr-2"></i>Histórico de Versões
            </h3>
        </div>
        <div class="px-6 py-4">
            <div class="space-y-4">
                {% for version in document.versions[-5:] %}
                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3">
                            <span class="font-mono text-sm font-medium">v{{ version.version }}</span>
                            <span class="text-sm text-gray-500">por {{ version.created_by.full_name }}</span>
                            <span class="text-sm text-gray-400">{{ version.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                        </div>
                        {% if version.change_notes %}
                        <p class="text-sm text-gray-600 mt-1">{{ version.change_notes }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Confirm document read
document.getElementById('confirm-read-btn')?.addEventListener('click', function() {
    if (confirm('Confirmar que você leu este documento?')) {
        fetch('{{ url_for("documents.confirm_read", id=document.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
});

// Print document
function printDocument() {
    const printWindow = window.open('', '_blank');
    const content = document.getElementById('document-content').innerHTML;

    printWindow.document.write(`
        <html>
        <head>
            <title>{{ document.title }}</title>
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; }
                table { border-collapse: collapse; width: 100%; margin: 10px 0; }
                table td, table th { border: 1px solid #ddd; padding: 8px; }
                table th { background-color: #f2f2f2; }
                h1, h2, h3 { color: #333; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <h1>{{ document.title }}</h1>
            <p><strong>Código:</strong> {{ document.code or 'N/A' }} | <strong>Versão:</strong> {{ document.version }}</p>
            <hr>
            ${content}
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}

// Toggle PDF dropdown
function togglePdfDropdown() {
    const dropdown = document.getElementById('pdf-dropdown-menu');
    dropdown.classList.toggle('hidden');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('pdf-dropdown');
    const menu = document.getElementById('pdf-dropdown-menu');

    if (!dropdown.contains(event.target)) {
        menu.classList.add('hidden');
    }
});
</script>
{% endblock %}