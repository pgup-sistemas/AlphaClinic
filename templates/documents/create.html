{% extends "base.html" %}

{% block title %}Criar Documento - Alphaclin QMS{% endblock %}

{% block content %}
<div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    <i class="fas fa-plus-circle mr-2 text-blue-600"></i>
                    Criar Novo Documento
                </h3>
                <p class="mt-1 max-w-2xl text-sm text-gray-500">
                    Editor completo de documentos - coração do sistema Alphaclin QMS
                </p>
            </div>
            <div class="flex space-x-3">
                <a href="{{ url_for('documents.index') }}" 
                   class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-md text-sm font-medium transition-colors">
                    <i class="fas fa-arrow-left mr-1"></i> Voltar
                </a>
            </div>
        </div>
    </div>

    <form method="POST" class="p-6 space-y-6">
        <!-- CSRF token will be added when Flask-WTF is properly configured -->
        <!-- Metadados do Documento -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-heading mr-1"></i>
                    Título do Documento *
                </label>
                <input type="text" 
                       id="title" 
                       name="title" 
                       required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Digite o título do documento">
            </div>
            
            <div>
                <label for="code" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-barcode mr-1"></i>
                    Código do Documento
                </label>
                <input type="text" 
                       id="code" 
                       name="code"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Ex: DOC-001">
            </div>
            
            <div>
                <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-tags mr-1"></i>
                    Categoria
                </label>
                <select id="category" 
                        name="category"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Selecione uma categoria</option>
                    <option value="procedimento">Procedimento</option>
                    <option value="instrucao">Instrução de Trabalho</option>
                    <option value="politica">Política</option>
                    <option value="manual">Manual</option>
                    <option value="formulario">Formulário</option>
                    <option value="outros">Outros</option>
                </select>
            </div>
            
            <div>
                <label for="folder_id" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-folder mr-1"></i>
                    Pasta
                </label>
                <select id="folder_id" 
                        name="folder_id"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Sem pasta</option>
                    {% for folder in folders %}
                    <option value="{{ folder.id }}">{{ folder.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Associação com Normas -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-clipboard-list mr-1"></i>
                Normas Associadas
            </label>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 p-4 border border-gray-200 rounded-md max-h-40 overflow-y-auto">
                {% for norm in norms %}
                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" 
                           name="norm_ids" 
                           value="{{ norm.id }}"
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="text-sm text-gray-700">{{ norm.name }} ({{ norm.code }})</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- Status do Documento -->
        <div>
            <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-info-circle mr-1"></i>
                Status do Documento
            </label>
            <select id="status"
                    name="status"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="draft">Rascunho</option>
                <option value="review">Em Revisão</option>
                <option value="published">Publicado</option>
            </select>
        </div>

        <!-- Editor de Conteúdo - CORAÇÃO DO SISTEMA -->
        <div>
            <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-edit mr-1"></i>
                Conteúdo do Documento
            </label>
            <div class="border border-gray-300 rounded-md">
                <textarea id="content" name="content" rows="20" class="w-full">
                    <h1>Título do Documento</h1>
                    <p>Conteúdo inicial do documento...</p>

                    <h2>Seção 1</h2>
                    <p>Texto da seção...</p>

                    <table border="1" style="border-collapse: collapse; width: 100%;">
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th style="padding: 8px; border: 1px solid #ddd;">Coluna 1</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Coluna 2</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Coluna 3</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">Dado 1</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">Dado 2</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">Dado 3</td>
                            </tr>
                        </tbody>
                    </table>
                </textarea>
            </div>

            <!-- Editor Controls -->
            <div class="mt-2 text-sm text-gray-500 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span><i class="fas fa-info-circle mr-1"></i>Editor WYSIWYG com suporte completo</span>
                    <span><i class="fas fa-image mr-1"></i>Imagens</span>
                    <span><i class="fas fa-table mr-1"></i>Tabelas</span>
                    <span><i class="fas fa-link mr-1"></i>Links</span>
                    <span><i class="fas fa-code mr-1"></i>HTML</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="button" id="toggle-source" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-code mr-1"></i>Ver HTML
                    </button>
                    <button type="button" id="preview-btn" class="text-green-600 hover:text-green-800">
                        <i class="fas fa-eye mr-1"></i>Visualizar
                    </button>
                </div>
            </div>
        </div>

        <!-- Ações -->
        <div class="flex items-center justify-between pt-6 border-t border-gray-200">
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-500">
                    <i class="fas fa-save mr-1"></i>
                    Status: <strong id="status-display">Rascunho</strong>
                </span>
                <span class="text-sm text-gray-500">
                    <i class="fas fa-clock mr-1"></i>
                    Última modificação: <strong id="last-modified">Agora</strong>
                </span>
            </div>
            <div class="flex items-center space-x-3">
                <button type="button" id="preview-btn"
                        class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-md text-sm font-medium transition-colors">
                    <i class="fas fa-eye mr-1"></i>
                    Visualizar
                </button>
                <button type="button" id="save-draft-btn"
                        class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                    <i class="fas fa-save mr-1"></i>
                    Salvar Rascunho
                </button>
                <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md text-sm font-medium transition-colors">
                    <i class="fas fa-save mr-1"></i>
                    Salvar Documento
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize TinyMCE Editor - CORAÇÃO DO SISTEMA
document.addEventListener('DOMContentLoaded', function() {
    tinymce.init({
        selector: '#content',
        height: 600,
        plugins: [
            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'help', 'wordcount', 'pagebreak',
            'print', 'save', 'directionality', 'nonbreaking', 'template', 'hr',
            'paste', 'textcolor', 'colorpicker', 'emoticons'
        ],
        toolbar1: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | forecolor backcolor',
        toolbar2: 'alignleft aligncenter alignright alignjustify | outdent indent | numlist bullist | link image media table | code preview fullscreen',
        toolbar3: 'searchreplace | pagebreak hr nonbreaking | template | save print | help',

        // Configurações para ambiente corporativo
        menubar: 'file edit view insert format tools table help',
        contextmenu: 'link image table',

        // Suporte a imagens
        image_advtab: true,
        image_uploadtab: true,
        images_upload_url: '/documents/upload-image',
        images_upload_handler: function (blobInfo, success, failure) {
            var xhr, formData;
            xhr = new XMLHttpRequest();
            xhr.withCredentials = false;
            xhr.open('POST', '/documents/upload-image');
            xhr.onload = function() {
                var json;
                if (xhr.status != 200) {
                    failure('HTTP Error: ' + xhr.status);
                    return;
                }
                json = JSON.parse(xhr.responseText);
                if (!json || typeof json.location != 'string') {
                    failure('Invalid JSON: ' + xhr.responseText);
                    return;
                }
                success(json.location);
            };
            formData = new FormData();
            formData.append('file', blobInfo.blob(), blobInfo.filename());
            xhr.send(formData);
        },

        // Configurações de tabela
        table_toolbar: 'tableprops tabledelete | tableinsertrowbefore tableinsertrowafter tabledeleterow | tableinsertcolbefore tableinsertcolafter tabledeletecol',
        table_appearance_options: true,
        table_grid: true,
        table_resize_bars: true,

        // Templates personalizados
        templates: [
            {
                title: 'Procedimento Padrão',
                description: 'Template para procedimentos operacionais',
                content: '<h1>PROCEDIMENTO: [NOME]</h1><h2>1. OBJETIVO</h2><p>Descrever o objetivo do procedimento...</p><h2>2. ESCOPO</h2><p>Definir o escopo de aplicação...</p><h2>3. RESPONSABILIDADES</h2><p>Definir responsabilidades...</p><h2>4. PROCEDIMENTO</h2><p>Descrever os passos...</p>'
            },
            {
                title: 'Instrução de Trabalho',
                description: 'Template para instruções de trabalho',
                content: '<h1>INSTRUÇÃO DE TRABALHO: [NOME]</h1><h2>1. FINALIDADE</h2><p>Descrever a finalidade...</p><h2>2. APLICAÇÃO</h2><p>Definir onde se aplica...</p><h2>3. DESCRIÇÃO</h2><p>Descrever as atividades step-by-step...</p>'
            }
        ],

        // Configurações para formato paisagem/retrato
        page_formats: 'A4=210x297mm;Letter=216x279mm;Legal=216x356mm',

        // Configuração de conteúdo
        content_style: `
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 12pt;
                line-height: 1.6;
                max-width: 210mm;
                margin: 0 auto;
                padding: 20mm;
            }
            table {
                border-collapse: collapse;
                width: 100%;
                margin: 10px 0;
            }
            table td, table th {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            table th {
                background-color: #f2f2f2;
                font-weight: bold;
            }
            h1 { color: #2563eb; border-bottom: 2px solid #2563eb; padding-bottom: 5px; }
            h2 { color: #1e40af; border-bottom: 1px solid #1e40af; padding-bottom: 3px; }
            .page-break { page-break-before: always; }
        `,

        // Configurações avançadas
        browser_spellcheck: true,
        contextmenu_never_use_native: true,

        // Configuração de salvamento automático
        autosave_ask_before_unload: true,
        autosave_interval: '30s',
        autosave_prefix: 'alphaclin-qms-{path}-{query}',

        // Configurações de acessibilidade
        accessibility_warnings: true,

        // Callbacks
        init_instance_callback: function (editor) {
            console.log('Editor TinyMCE inicializado:', editor.id);
        },

        setup: function (editor) {
            editor.on('change', function () {
                console.log('Conteúdo alterado no editor');
            });
        }
    });
});

// Toggle source view
document.getElementById('toggle-source').addEventListener('click', function() {
    tinymce.activeEditor.execCommand('mceCodeEditor');
});

// Preview functionality
document.getElementById('preview-btn').addEventListener('click', function() {
    tinymce.triggerSave();
    const content = document.getElementById('content').value;
    const title = document.getElementById('title').value;

    // Open preview in new window
    const previewWindow = window.open('', '_blank', 'width=800,height=600');
    previewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Preview: ${title}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                table { border-collapse: collapse; width: 100%; }
                table td, table th { border: 1px solid #ddd; padding: 8px; }
                table th { background-color: #f2f2f2; }
            </style>
        </head>
        <body>
            <h1>${title}</h1>
            ${content}
        </body>
        </html>
    `);
    previewWindow.document.close();
});

// Status change handler
document.getElementById('status').addEventListener('change', function() {
    const status = this.value;
    const statusDisplay = document.getElementById('status-display');

    const statusLabels = {
        'draft': 'Rascunho',
        'review': 'Em Revisão',
        'published': 'Publicado'
    };

    statusDisplay.textContent = statusLabels[status] || 'Rascunho';
});

// Auto-save draft functionality
let autoSaveTimer;
function autoSave() {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => {
        tinymce.triggerSave();
        const formData = new FormData(document.querySelector('form'));
        formData.set('status', 'draft'); // Force draft status for auto-save

        fetch(window.location.href, {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                document.getElementById('last-modified').textContent = new Date().toLocaleTimeString();
                console.log('Rascunho salvo automaticamente');
            }
        }).catch(error => {
            console.error('Erro ao salvar rascunho:', error);
        });
    }, 30000); // Auto-save every 30 seconds
}

// Save draft manually
document.getElementById('save-draft-btn').addEventListener('click', function() {
    tinymce.triggerSave();
    const formData = new FormData(document.querySelector('form'));
    formData.set('status', 'draft');

    fetch(window.location.href, {
        method: 'POST',
        body: formData
    }).then(response => {
        if (response.ok) {
            document.getElementById('last-modified').textContent = new Date().toLocaleTimeString();
            alert('Rascunho salvo com sucesso!');
        } else {
            alert('Erro ao salvar rascunho.');
        }
    }).catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar rascunho.');
    });
});

// Content change listener for auto-save
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (tinymce.activeEditor) {
            tinymce.activeEditor.on('change keyup', autoSave);
        }
    }, 1000);
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    if (!title) {
        e.preventDefault();
        alert('O título do documento é obrigatório!');
        document.getElementById('title').focus();
        return false;
    }

    // Update textarea with TinyMCE content before submit
    tinymce.triggerSave();
});
</script>
{% endblock %}