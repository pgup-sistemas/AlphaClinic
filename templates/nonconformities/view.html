{% extends "base.html" %}

{% block title %}{{ nc.title }} - Alphaclin QMS{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900 truncate">
                                {{ nc.title }}
                            </h1>
                            <div class="flex items-center space-x-4 text-sm text-gray-500 mt-1">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if nc.severity == 'critical' %}bg-red-100 text-red-800
                                    {% elif nc.severity == 'major' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-blue-100 text-blue-800{% endif %}">
                                    {{ nc.severity|title }}
                                </span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if nc.status == 'open' %}bg-red-100 text-red-800
                                    {% elif nc.status == 'in_progress' %}bg-yellow-100 text-yellow-800
                                    {% elif nc.status == 'resolved' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {% if nc.status == 'open' %}Aberta
                                    {% elif nc.status == 'in_progress' %}Em Progresso
                                    {% elif nc.status == 'resolved' %}Resolvida
                                    {% elif nc.status == 'closed' %}Fechada
                                    {% else %}{{ nc.status|title }}{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    {% if nc.capa_plans %}
                    <a href="{{ url_for('nonconformities.view_capa', nc_id=nc.id, capa_id=nc.capa_plans[0].id) }}"
                       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-clipboard-check mr-1"></i> Ver CAPA
                    </a>
                    {% else %}
                    <a href="{{ url_for('nonconformities.create_capa', id=nc.id) }}"
                       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-plus mr-1"></i> Criar CAPA
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- NC Info -->
        <div class="px-6 py-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <dt class="text-sm font-medium text-gray-500">Identificada em</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ nc.identified_date.strftime('%d/%m/%Y') }}</dd>
                </div>
                {% if nc.identified_by %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Identificada por</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ nc.identified_by.full_name }}</dd>
                </div>
                {% endif %}
                {% if nc.target_resolution_date %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Prazo para resolução</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ nc.target_resolution_date.strftime('%d/%m/%Y') }}</dd>
                </div>
                {% endif %}
                {% if nc.actual_resolution_date %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Resolvida em</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ nc.actual_resolution_date.strftime('%d/%m/%Y') }}</dd>
                </div>
                {% endif %}
                {% if nc.assigned_to %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Responsável</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ nc.assigned_to.full_name }}</dd>
                </div>
                {% endif %}
                {% if nc.requirement %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Requisito da norma</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ nc.requirement }}</dd>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Description -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Descrição da Não Conformidade</h3>
        <div class="prose max-w-none text-gray-700">
            {{ nc.description }}
        </div>
    </div>

    <!-- CAPA Status -->
    {% if nc.capa_plans %}
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fas fa-clipboard-check mr-2 text-blue-600"></i>
            Plano de Ação Corretiva e Preventiva (CAPA)
        </h3>

        {% for capa in nc.capa_plans %}
        <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-3">
                    <span class="text-sm font-medium text-gray-900">{{ capa.reference_number }}</span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        {% if capa.status.value == 'draft' %}bg-gray-100 text-gray-800
                        {% elif capa.status.value == 'approved' %}bg-blue-100 text-blue-800
                        {% elif capa.status.value == 'implemented' %}bg-yellow-100 text-yellow-800
                        {% elif capa.status.value == 'verified' %}bg-purple-100 text-purple-800
                        {% elif capa.status.value == 'closed' %}bg-green-100 text-green-800
                        {% else %}bg-red-100 text-red-800{% endif %}">
                        {{ capa.status.value|title }}
                    </span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        {% if capa.capa_type.value == 'corrective' %}bg-red-100 text-red-800
                        {% else %}bg-blue-100 text-blue-800{% endif %}">
                        {{ 'Corretiva' if capa.capa_type.value == 'corrective' else 'Preventiva' }}
                    </span>
                </div>
                <a href="{{ url_for('nonconformities.view_capa', nc_id=nc.id, capa_id=capa.id) }}"
                   class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    Ver detalhes →
                </a>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="font-medium text-gray-700">O QUE:</span>
                    <p class="text-gray-600 mt-1">{{ capa.what[:100] }}{% if capa.what|length > 100 %}...{% endif %}</p>
                </div>
                <div>
                    <span class="font-medium text-gray-700">QUANDO:</span>
                    <p class="text-gray-600 mt-1">{{ capa.when.strftime('%d/%m/%Y') }}</p>
                </div>
                <div>
                    <span class="font-medium text-gray-700">QUEM:</span>
                    <p class="text-gray-600 mt-1">{{ capa.who }}</p>
                </div>
                <div>
                    <span class="font-medium text-gray-700">COMO:</span>
                    <p class="text-gray-600 mt-1">{{ capa.how[:100] }}{% if capa.how|length > 100 %}...{% endif %}</p>
                </div>
            </div>

            {% if capa.effectiveness_rating %}
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-medium text-gray-700">Avaliação de efetividade:</span>
                    <div class="flex items-center">
                        {% for i in range(5) %}
                        <i class="fas fa-star {% if i < capa.effectiveness_rating %}text-yellow-400{% else %}text-gray-300{% endif %}"></i>
                        {% endfor %}
                        <span class="ml-2 text-sm text-gray-600">{{ capa.effectiveness_rating }}/5</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Related Audit -->
    {% if nc.audit %}
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fas fa-clipboard-check mr-2 text-green-600"></i>
            Auditoria Relacionada
        </h3>
        <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="text-lg font-medium text-gray-900">{{ nc.audit.title }}</h4>
                    <div class="flex items-center space-x-4 text-sm text-gray-500 mt-1">
                        <span>Tipo: {{ nc.audit.audit_type.value|title }}</span>
                        {% if nc.audit.norm %}
                        <span>Norma: {{ nc.audit.norm.code }}</span>
                        {% endif %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if nc.audit.status == 'completed' %}bg-green-100 text-green-800
                            {% elif nc.audit.status == 'in_progress' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            Status: {{ nc.audit.status|title }}
                        </span>
                    </div>
                </div>
                <a href="{{ url_for('audits.view', id=nc.audit.id) }}"
                   class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    Ver auditoria →
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}