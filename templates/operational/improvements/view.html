{% extends "base.html" %}

{% block title %}{{ improvement.title }} - Alphaclin QMS{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">{{ improvement.title }}</h1>
                <p class="text-gray-600 mt-1">Ciclo de Melhoria PDCA</p>
                <div class="flex items-center mt-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        {% if improvement.status == 'completed' %}bg-green-100 text-green-800
                        {% else %}bg-blue-100 text-blue-800{% endif %}">
                        {% if improvement.status == 'completed' %}Concluído{% else %}Ativo{% endif %}
                    </span>
                    <span class="ml-4 text-sm text-gray-500">
                        Criado em {{ improvement.created_at.strftime('%d/%m/%Y') }}
                    </span>
                </div>
            </div>
            <div class="flex space-x-3">
                <a href="{{ url_for('operational.improvements_index') }}"
                   class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded">
                    Voltar à Lista
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- PDCA Phases -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Plan Phase -->
            <div class="bg-white shadow rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                            <span class="text-sm font-bold text-blue-600">P</span>
                        </div>
                        Plan (Planejar)
                    </h3>
                    {% if improvement.current_phase.value == 'plan' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        Fase Atual
                    </span>
                    {% endif %}
                </div>

                {% if improvement.plan_description %}
                <div class="prose prose-sm max-w-none mb-4">
                    <pre class="whitespace-pre-wrap text-sm text-gray-700">{{ improvement.plan_description }}</pre>
                </div>
                {% else %}
                <p class="text-sm text-gray-500 mb-4">Descrição da fase Plan não definida.</p>
                {% endif %}

                {% if improvement.current_phase.value == 'plan' and improvement.status != 'completed' %}
                <form method="POST" action="{{ url_for('operational.improvements_update_phase', id=improvement.id) }}" class="space-y-3">
                    <input type="hidden" name="phase" value="do">
                    <div>
                        <label for="plan_description" class="block text-sm font-medium text-gray-700 mb-1">
                            Descrição da Fase Plan
                        </label>
                        <textarea name="description" id="plan_description" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Descreva o planejamento da melhoria...">{{ improvement.plan_description or '' }}</textarea>
                    </div>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm">
                        Avançar para Do →
                    </button>
                </form>
                {% endif %}
            </div>

            <!-- Do Phase -->
            <div class="bg-white shadow rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center mr-3">
                            <span class="text-sm font-bold text-green-600">D</span>
                        </div>
                        Do (Executar)
                    </h3>
                    {% if improvement.current_phase.value == 'do' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        Fase Atual
                    </span>
                    {% endif %}
                </div>

                {% if improvement.do_description %}
                <div class="prose prose-sm max-w-none mb-4">
                    <pre class="whitespace-pre-wrap text-sm text-gray-700">{{ improvement.do_description }}</pre>
                </div>
                {% else %}
                <p class="text-sm text-gray-500 mb-4">Descrição da fase Do não definida.</p>
                {% endif %}

                {% if improvement.current_phase.value == 'do' and improvement.status != 'completed' %}
                <form method="POST" action="{{ url_for('operational.improvements_update_phase', id=improvement.id) }}" class="space-y-3">
                    <input type="hidden" name="phase" value="check">
                    <div>
                        <label for="do_description" class="block text-sm font-medium text-gray-700 mb-1">
                            Descrição da Fase Do
                        </label>
                        <textarea name="description" id="do_description" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Descreva a execução da melhoria...">{{ improvement.do_description or '' }}</textarea>
                    </div>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">
                        Avançar para Check →
                    </button>
                </form>
                {% endif %}
            </div>

            <!-- Check Phase -->
            <div class="bg-white shadow rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center mr-3">
                            <span class="text-sm font-bold text-yellow-600">C</span>
                        </div>
                        Check (Verificar)
                    </h3>
                    {% if improvement.current_phase.value == 'check' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                        Fase Atual
                    </span>
                    {% endif %}
                </div>

                {% if improvement.check_description %}
                <div class="prose prose-sm max-w-none mb-4">
                    <pre class="whitespace-pre-wrap text-sm text-gray-700">{{ improvement.check_description }}</pre>
                </div>
                {% else %}
                <p class="text-sm text-gray-500 mb-4">Descrição da fase Check não definida.</p>
                {% endif %}

                {% if improvement.current_phase.value == 'check' and improvement.status != 'completed' %}
                <form method="POST" action="{{ url_for('operational.improvements_update_phase', id=improvement.id) }}" class="space-y-3">
                    <input type="hidden" name="phase" value="act">
                    <div>
                        <label for="check_description" class="block text-sm font-medium text-gray-700 mb-1">
                            Descrição da Fase Check
                        </label>
                        <textarea name="description" id="check_description" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Descreva a verificação dos resultados...">{{ improvement.check_description or '' }}</textarea>
                    </div>
                    <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded text-sm">
                        Avançar para Act →
                    </button>
                </form>
                {% endif %}
            </div>

            <!-- Act Phase -->
            <div class="bg-white shadow rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center mr-3">
                            <span class="text-sm font-bold text-purple-600">A</span>
                        </div>
                        Act (Agir)
                    </h3>
                    {% if improvement.current_phase.value == 'act' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                        Fase Atual
                    </span>
                    {% endif %}
                </div>

                {% if improvement.act_description %}
                <div class="prose prose-sm max-w-none mb-4">
                    <pre class="whitespace-pre-wrap text-sm text-gray-700">{{ improvement.act_description }}</pre>
                </div>
                {% else %}
                <p class="text-sm text-gray-500 mb-4">Descrição da fase Act não definida.</p>
                {% endif %}

                {% if improvement.current_phase.value == 'act' and improvement.status != 'completed' %}
                <form method="POST" action="{{ url_for('operational.improvements_update_phase', id=improvement.id) }}" class="space-y-3">
                    <input type="hidden" name="phase" value="completed">
                    <div>
                        <label for="act_description" class="block text-sm font-medium text-gray-700 mb-1">
                            Descrição da Fase Act
                        </label>
                        <textarea name="description" id="act_description" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Descreva as ações padronizadas...">{{ improvement.act_description or '' }}</textarea>
                    </div>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded text-sm">
                        Concluir Ciclo PDCA ✓
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Improvement Details -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Detalhes</h3>
                <dl class="space-y-3">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Responsável</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ improvement.responsible.full_name }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Categoria</dt>
                        <dd class="mt-1 text-sm text-gray-900 capitalize">{{ improvement.category }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Prioridade</dt>
                        <dd class="mt-1 text-sm text-gray-900 capitalize">{{ improvement.priority }}</dd>
                    </div>
                    {% if improvement.target_completion_date %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Data Alvo</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ improvement.target_completion_date.strftime('%d/%m/%Y') }}</dd>
                    </div>
                    {% endif %}
                    {% if improvement.actual_completion_date %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Concluído em</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ improvement.actual_completion_date.strftime('%d/%m/%Y') }}</dd>
                    </div>
                    {% endif %}
                </dl>
            </div>

            <!-- Quick Actions -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="text-sm font-medium text-gray-900 mb-3">Ações Rápidas</h4>
                <div class="space-y-2">
                    {% if improvement.status != 'completed' %}
                    <form method="POST" action="{{ url_for('operational.improvements_update_phase', id=improvement.id) }}" class="inline-block w-full">
                        <input type="hidden" name="phase" value="do">
                        <button type="submit" class="w-full text-left px-3 py-2 text-sm text-gray-700 bg-white hover:bg-gray-100 rounded-md">
                            <i class="fas fa-play mr-2"></i>Avançar Fase
                        </button>
                    </form>
                    {% endif %}
                    <a href="{{ url_for('operational.improvements_create') }}"
                       class="block w-full text-left px-3 py-2 text-sm text-gray-700 bg-white hover:bg-gray-100 rounded-md">
                        <i class="fas fa-plus mr-2"></i>Novo Ciclo PDCA
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}